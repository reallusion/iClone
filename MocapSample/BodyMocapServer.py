import os
import socket
import time
import json
from socketserver import BaseRequestHandler, TCPServer

HOST = '0.0.0.0'
PORT = 999
send_data = []
bone_count = 0
cur_step = 0
step_count = 20

fram1_data = [-0.05, 106.89, -3.65, -6.91, 173.25, -1.78, -11.44, -1.88, -0.06, -6.14, 12.7, -9.17, 0.19, -48.07, 0.02, 27.03, -11.94, 0.71, 0.52, -48.92, -0.88, -7.01, -2.03, 16.63, 11.54, -1.81, -0.15, 6.95, 20.59, 4.21, 0.11, -48.01, 0.07, 6.32, -4.32, 0.42, 0.84, -47.31, -0.06, -7.0, 21.87, -1.47, -0.1, 16.66, -0.05, 3.42, 0.62, -2.97, -0.04, 11.32, -0.06, 0.86, 0.14, -0.75, -0.02, 11.78, 0.01, 1.43, 0.21, -1.24, -0.05, 11.31, -0.03, 0.33, -1.32, 0.27, -0.15, 12.08, -0.0, 0.34, -1.33, 0.27, -0.14, 9.01, 0.01, 8.37, -24.14, 3.38, -3.52, 8.02, -0.02, -2.34, 1.02, 10.14, -14.04, -0.15, -0.07, -27.48, 30.59, 18.74, -28.99, -0.1, -0.12, 7.78, 36.33, 6.57, -27.99, -0.02, -0.02, 18.56, -1.48, -48.22, -2.7, 0.21, 3.39, -0.0, 56.65, 24.69, -4.0, 0.0, 0.0, -0.0, 13.01, 7.06, -2.78, 0.0, 0.0, -0.0, -3.83, 0.0, -3.5, 0.55, 2.15, -0.0, 0.0, 0.0, -5.66, -0.1, 1.08, -0.0, 15.0, 12.78, -3.93, 0.0, 0.0, -0.0, 0.0, 12.78, -2.23, 0.0, 0.0, -0.0, 0.0, 12.78, -3.67, 0.56, 0.82, -0.0, 0.0, 0.0, -5.62, -0.09, 0.34, -0.0, 0.0, 14.26, -4.29, 0.0, 0.0, -0.0, 0.0, 14.26, -2.69, 0.0, 0.0, -0.0, 0.0, 14.26, -3.65, 0.58, -0.14, -0.0, 0.0, 0.0, -5.03, -0.02, -0.52, -0.0, -15.0, 13.89, -3.74, 0.0, 0.0, -0.0, 0.0, 13.89, -2.59, 0.0, 0.0, -0.0, 0.0, 13.89, -3.43, 0.51, -1.3, -0.0, 0.0, 0.0, -4.5, -0.02, -1.18, -0.0, -25.0, 10.03, -2.99, 0.0, 0.0, -0.0, 0.0, 10.03, -1.89, 0.0, 0.0, -0.0, 0.0, 10.03, 3.48, 8.09, 0.04, 5.92, 19.77, -1.93, 14.08, 0.06, 0.03, 1.13, -12.31, -70.29, 28.98, 0.11, 0.07, 3.24, -2.94, 1.22, 28.0, -0.02, 0.26, 4.08, 10.77, 6.19, 2.7, 0.21, 3.39, -0.0, -52.26, -28.52, 4.0, 0.0, 0.0, -0.0, -2.75, -5.08, 2.78, 0.0, 0.0, -0.0, -5.53, 0.0, 3.5, 0.55, 2.15, -0.0, 0.0, 0.0, 5.66, -0.1, 1.08, -0.0, -15.0, -16.84, 3.93, 0.0, 0.0, -0.0, 0.0, -16.84, 2.23, 0.0, 0.0, -0.0, 0.0, -16.84, 3.67, 0.56, 0.82, -0.0, 0.0, 0.0, 5.62, -0.09, 0.34, -0.0, 0.0, -18.32, 4.29, 0.0, 0.0, -0.0, 0.0, -18.32, 2.69, 0.0, 0.0, -0.0, 0.0, -18.32, 3.65, 0.58, -0.14, -0.0, 0.0, 0.0, 5.03, -0.02, -0.52, -0.0, 15.0, -21.5, 3.74, 0.0, 0.0, -0.0, 0.0, -21.5, 2.59, 0.0, 0.0, -0.0, 0.0, -21.5, 3.43, 0.51, -1.3, -0.0, 0.0, 0.0, 4.5, -0.02, -1.18, -0.0, 25.0, -24.8, 2.99, 0.0, 0.0, -0.0, 0.0, -24.8, 1.89, 0.0, 0.0, -0.0, 0.0, -24.8]
fram2_data = [6.44, 106.86, 2.11, -6.0, 144.52, -2.36, -11.52, -1.83, -0.05, 7.03, 9.66, 1.24, -0.07, -48.0, -0.04, 3.28, -11.53, -0.02, 0.81, -47.99, -0.85, -4.79, 2.47, 2.48, 11.55, -1.86, 0.02, 5.86, 10.68, 8.65, 0.17, -47.99, 0.05, 6.93, -0.61, 4.33, -0.25, -47.97, 0.22, -3.08, 22.35, -10.46, 0.04, 16.65, 0.0, 3.11, -0.77, 2.42, 0.01, 11.31, -0.03, 0.78, -0.18, 0.61, -0.02, 11.78, -0.0, 1.31, -0.28, 1.01, -0.02, 11.31, -0.01, 0.04, -0.33, 0.2, 0.02, 12.09, -0.04, 0.04, -0.33, 0.2, -0.03, 9.0, -0.08, 1.2, -5.81, 3.62, -3.51, 8.06, 0.02, -3.8, -0.27, 7.17, -14.01, -0.01, -0.01, -0.67, 7.81, 71.31, -29.0, 0.01, -0.15, -4.46, 0.72, 6.46, -28.0, 0.05, -0.07, 13.32, -6.34, -14.73, -2.7, 0.21, 3.39, -0.0, 51.61, 20.16, -4.0, 0.0, 0.0, -0.0, 2.94, 2.53, -2.78, 0.0, 0.0, -0.0, 5.46, 0.0, -3.5, 0.55, 2.15, -0.0, 0.0, 0.0, -5.66, -0.1, 1.08, -0.0, 15.0, 19.35, -3.93, 0.0, 0.0, -0.0, 0.0, 19.35, -2.23, 0.0, 0.0, -0.0, 0.0, 19.35, -3.67, 0.56, 0.82, -0.0, 0.0, 0.0, -5.62, -0.09, 0.34, -0.0, 0.0, 23.71, -4.29, 0.0, 0.0, -0.0, 0.0, 23.71, -2.69, 0.0, 0.0, -0.0, 0.0, 23.71, -3.65, 0.58, -0.14, -0.0, 0.0, 0.0, -5.03, -0.02, -0.52, -0.0, -15.0, 22.43, -3.74, 0.0, 0.0, -0.0, 0.0, 22.43, -2.59, 0.0, 0.0, -0.0, 0.0, 22.43, -3.43, 0.51, -1.3, -0.0, 0.0, 0.0, -4.5, -0.02, -1.18, -0.0, -25.0, 18.58, -2.99, 0.0, 0.0, -0.0, 0.0, 18.58, -1.89, 0.0, 0.0, -0.0, 0.0, 18.58, 3.49, 8.08, 0.03, 2.26, 10.43, -4.93, 14.02, 0.02, 0.07, 4.27, -8.99, -74.93, 29.0, 0.1, 0.04, -2.67, -3.66, 4.19, 28.01, 0.05, 0.03, 4.62, 3.08, 7.23, 2.7, 0.21, 3.39, -0.0, -52.71, -22.76, 4.0, 0.0, 0.0, -0.0, -3.65, 0.68, 2.78, 0.0, 0.0, -0.0, -2.84, 0.0, 3.5, 0.55, 2.15, -0.0, 0.0, 0.0, 5.66, -0.1, 1.08, -0.0, -15.0, -14.1, 3.93, 0.0, 0.0, -0.0, 0.0, -14.1, 2.23, 0.0, 0.0, -0.0, 0.0, -14.1, 3.67, 0.56, 0.82, -0.0, 0.0, 0.0, 5.62, -0.09, 0.34, -0.0, 0.0, -17.7, 4.29, 0.0, 0.0, -0.0, 0.0, -17.7, 2.69, 0.0, 0.0, -0.0, 0.0, -17.7, 3.65, 0.58, -0.14, -0.0, 0.0, 0.0, 5.03, -0.02, -0.52, -0.0, 15.0, -18.98, 3.74, 0.0, 0.0, -0.0, 0.0, -18.98, 2.59, 0.0, 0.0, -0.0, 0.0, -18.98, 3.43, 0.51, -1.3, -0.0, 0.0, 0.0, 4.5, -0.02, -1.18, -0.0, 25.0, -24.32, 2.99, 0.0, 0.0, -0.0, 0.0, -24.32, 1.89, 0.0, 0.0, -0.0, 0.0, -24.32]

class EchoHandler(BaseRequestHandler):
    def handle(self):
        global send_data
        global cur_step
        global step_count
        global fram1_data
        global fram2_data

        print('Got connection from', self.client_address)
        while True:
            ratio = cur_step / step_count
            for bone_idx in range(bone_count):
                for idx in range(bone_idx*6, (bone_idx+1)*6):
                    send_data[idx] = (1.0-ratio)*fram1_data[idx] + ratio*fram2_data[idx]
            send_str = json.dumps(send_data)
            cur_step += 1
            if cur_step > step_count:
                cur_step = 0
            self.request.send(send_str.encode())
            time.sleep(0.05)

if __name__ == '__main__':

    send_data = [0]*len(fram1_data)
    bone_count = int(len(fram1_data)/6)
    print("bone count = "+str(bone_count))
    HOST = str(socket.gethostbyname(socket.gethostname()))
    print("Facail Mocap Server ip: "+HOST+":"+str(PORT))
    serv = TCPServer((HOST, PORT), EchoHandler)
    serv.serve_forever()
